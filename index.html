<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Math Showdown Pro - Kesintisiz Lobi</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00d2ff; --accent: #9d50bb; --bg: #020205; --danger: #ff4b2b; --gold: #ffd700; --glass: rgba(255, 255, 255, 0.05); }
        body { font-family: 'Rajdhani', sans-serif; background: var(--bg); color: white; margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .card { background: rgba(10, 10, 15, 0.95); backdrop-filter: blur(20px); padding: 30px; border-radius: 24px; border: 1px solid rgba(0, 210, 255, 0.3); box-shadow: 0 0 50px rgba(0, 0, 0, 0.8); width: 500px; text-align: center; }
        .hidden { display: none; }
        .avatar-upload { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary); margin: 0 auto 15px; cursor: pointer; object-fit: cover; background: #111; display: block; }
        .player-list { background: var(--glass); border-radius: 12px; padding: 10px; margin: 15px 0; min-height: 50px; }
        .player-entry { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #333; }
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; text-align: left; }
        label { font-size: 11px; color: #888; }
        input { background: #1a1a2e; border: 1px solid #333; color: white; padding: 10px; border-radius: 8px; width: 85%; font-family: 'Orbitron'; }
        .btn { background: linear-gradient(45deg, #00d2ff, #3a7bd5); color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: 700; width: 100%; font-family: 'Orbitron'; margin-top: 10px; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; }
        #num-display { font-family: 'Orbitron'; font-size: 110px; height: 150px; display: flex; align-items: center; justify-content: center; }
        .hp-bar { height: 8px; background: #222; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .hp-fill { height: 100%; width: 100%; background: linear-gradient(90deg, var(--danger), #ff8e53); transition: width 0.4s ease; }
    </style>
</head>
<body>

    <div id="login-screen" class="card">
        <h2 style="font-family: 'Orbitron'; color: var(--primary);">MATH LOGIN</h2>
        <img id="avatar-preview" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="avatar-upload" onclick="document.getElementById('file-input').click()">
        <input type="file" id="file-input" class="hidden" accept="image/*">
        <input type="text" id="username" placeholder="Pilot Adı...">
        <button class="btn" onclick="joinLobby()">LOBİYE KATIL</button>
    </div>

    <div id="lobby-screen" class="card hidden">
        <h2 style="font-family: 'Orbitron'; color: var(--primary);">LOBİ</h2>
        <div class="player-list" id="player-list"></div>
        <div id="mod-panel" class="hidden">
            <div class="settings-grid">
                <div><label>Sayı Adedi</label><input type="number" id="cfg-count" value="5"></div>
                <div><label>Hız (sn)</label><input type="number" id="cfg-speed" value="0.8" step="0.1"></div>
                <div><label>Basamak</label><input type="number" id="cfg-digits" value="2"></div>
                <div><label>Başlangıç HP</label><input type="number" id="cfg-hp" value="100"></div>
            </div>
            <label style="font-size: 11px; color: var(--danger); margin-top: 10px; display: block;">
                <input type="checkbox" id="cfg-neg"> NEGATİF SAYILAR
            </label>
        </div>
        <button id="start-btn" class="btn" disabled onclick="triggerStart()">OYUNU BAŞLAT</button>
        <button id="pve-btn" class="btn" style="background:none; border:1px solid var(--accent); color:var(--accent);" onclick="startPvE()">BİLGİSAYARA KARŞI</button>
    </div>

    <div id="game-screen" class="card hidden">
        <div id="hp-ui" style="display:flex; gap:15px; margin-bottom:20px;"></div>
        <div id="num-display">...</div>
        <div id="action-zone" class="hidden">
            <input type="number" id="user-guess" placeholder="Toplam?" style="width: 150px; font-size: 24px;">
            <button class="btn" onclick="submitGuess()" style="width: auto; padding: 10px 40px;">GÖNDER</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, onDisconnect, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBcm1uY37IelMsTqoD0sAmsIH1nwBeYtCE",
        authDomain: "sahtekar-2f5d2.firebaseapp.com",
        databaseURL: "https://sahtekar-2f5d2-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "sahtekar-2f5d2",
        appId: "1:223883537002:web:1c16bde374d11efb5d7813"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const roomRef = ref(db, 'mathRoom');

    let myId = "id_" + Math.floor(Math.random() * 1000000);
    let me = { id: myId, name: "", avatar: "", isMod: false, hp: 100, lastGuess: null };
    let allPlayers = {};
    let currentGameState = 'lobby';
    let targetSum = 0;

    // Fotoğraf Seçimi
    document.getElementById('file-input').onchange = e => {
        const r = new FileReader();
        r.onload = () => { document.getElementById('avatar-preview').src = r.result; me.avatar = r.result; };
        r.readAsDataURL(e.target.files[0]);
    };

    window.joinLobby = async function() {
        me.name = document.getElementById('username').value || "Pilot_" + Math.floor(Math.random()*100);
        if(!me.avatar) me.avatar = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

        const snapshot = await get(roomRef);
        const data = snapshot.val();
        
        if(!data || !data.players) {
            me.isMod = true;
            await set(roomRef, { moderatorId: myId, status: 'lobby', config: {} });
        }
        
        await set(ref(db, `mathRoom/players/${myId}`), me);
        onDisconnect(ref(db, `mathRoom/players/${myId}`)).remove();

        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('lobby-screen').classList.remove('hidden');
        listenToFirebase();
    };

    function listenToFirebase() {
        onValue(roomRef, (snapshot) => {
            const data = snapshot.val();
            if(!data) return;

            allPlayers = data.players || {};
            const playersArr = Object.values(allPlayers);

            // Lobi UI
            if(currentGameState === 'lobby') {
                document.getElementById('player-list').innerHTML = playersArr.map(p => `
                    <div class="player-entry">
                        <img src="${p.avatar}" style="width:30px; height:30px; border-radius:50%">
                        <span>${p.name} ${p.id === data.moderatorId ? '<b style="color:gold">(MOD)</b>' : ''}</span>
                    </div>
                `).join('');
                
                if(myId === data.moderatorId) {
                    document.getElementById('mod-panel').classList.remove('hidden');
                    document.getElementById('start-btn').disabled = playersArr.length < 2;
                }
            }

            // Oyun Akış Senkronizasyonu
            if(data.status === 'playing' && currentGameState === 'lobby') {
                currentGameState = 'playing';
                document.getElementById('lobby-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                startRound(data.config);
            }

            // HP Güncelleme (Sayfa yenilenmeden)
            playersArr.forEach(p => {
                const bar = document.getElementById(`bar-${p.id}`);
                if(bar) bar.style.width = (p.hp / (data.config.hp || 100) * 100) + "%";
            });

            // Oyun Bitiş Kontrolü
            if(playersArr.some(p => p.hp <= 0)) {
                const winner = playersArr.find(p => p.hp > 0);
                alert("OYUN BİTTİ! Kazanan: " + (winner ? winner.name : "Yok"));
                location.reload(); 
            }
        });
    }

    window.triggerStart = function() {
        const config = {
            count: parseInt(document.getElementById('cfg-count').value),
            speed: parseFloat(document.getElementById('cfg-speed').value) * 1000,
            digits: parseInt(document.getElementById('cfg-digits').value),
            hp: parseInt(document.getElementById('cfg-hp').value),
            neg: document.getElementById('cfg-neg').checked,
            seed: Math.random()
        };
        update(roomRef, { status: 'playing', config: config });
    };

    window.startPvE = function() {
        set(ref(db, `mathRoom/players/bot_99`), {
            id: 'bot_99', name: "BOT_ZEHRA", hp: 100, avatar: "https://cdn-icons-png.flaticon.com/512/4712/4712035.png", isMod: false
        });
        setTimeout(triggerStart, 500);
    };

    async function startRound(conf) {
        renderHP();
        const display = document.getElementById('num-display');
        targetSum = 0;
        let rng = conf.seed;

        for (let i = 0; i < conf.count; i++) {
            let n = Math.floor(Math.abs(Math.sin(rng++)) * (Math.pow(10, conf.digits) - Math.pow(10, conf.digits-1))) + Math.pow(10, conf.digits-1);
            if(conf.neg && Math.sin(rng++) > 0.5) n = -n;
            
            targetSum += n;
            display.innerText = (n > 0 ? "+" : "") + n;
            display.style.color = n < 0 ? "var(--danger)" : "var(--primary)";
            await new Promise(r => setTimeout(r, conf.speed));
            display.innerText = "";
            await new Promise(r => setTimeout(r, 100));
        }

        display.innerText = "???";
        document.getElementById('action-zone').classList.remove('hidden');
    }

    window.submitGuess = async function() {
        const guess = parseInt(document.getElementById('user-guess').value);
        if(isNaN(guess)) return;

        const diff = Math.abs(targetSum - guess);
        
        // Hasar Hesaplama (Firebase'e yaz)
        me.hp -= diff;
        await update(ref(db, `mathRoom/players/${myId}`), { hp: me.hp });

        // Bot varsa ona da hasar verdir
        if(allPlayers['bot_99']) {
            const botDiff = Math.floor(Math.random() * 15);
            allPlayers['bot_99'].hp -= botDiff;
            await update(ref(db, `mathRoom/players/bot_99`), { hp: allPlayers['bot_99'].hp });
        }

        // Yeni tura hazırla (Reload yapmadan!)
        document.getElementById('action-zone').classList.add('hidden');
        document.getElementById('user-guess').value = "";
        
        // Moderatör yeni seed üretir ve turu resetler
        if(me.isMod) {
            setTimeout(() => {
                const newSeed = Math.random();
                update(roomRef, { 'config/seed': newSeed });
                startRound(allPlayers.config || { ...JSON.parse(JSON.stringify(allPlayers)).config, seed: newSeed });
            }, 2000);
        }
    }

    function renderHP() {
        const ui = document.getElementById('hp-ui');
        ui.innerHTML = Object.values(allPlayers).map(p => `
            <div style="flex:1">
                <div style="font-size:10px;">${p.name}</div>
                <div class="hp-bar"><div id="bar-${p.id}" class="hp-fill"></div></div>
            </div>
        `).join('');
    }
</script>
</body>
</html>
